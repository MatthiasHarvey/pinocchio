{% extends "peer_review/base.html" %}
{% comment %}
Todo:
    Search question lists
    Filter question lists by type
    Move grouping choice to questionnaireAdmin
{% endcomment %}
{% load staticfiles %}

{% block extrahead %}
    <script src="{% static "peer_review/js/tinymce/tinymce.min.js" %}"></script>
    <title>Questionnaire Admin</title>
    <script>
        var title="questionnaireAdmin";
    </script>

{% endblock %}

{% block context %}
    <div class = "container">
        {% if messages %}
            {% for message in messages %}
            <div class = "alert alert-{{ message.tags }}"><strong>{{ message }}</strong></div>
            {% endfor %}
        {% endif %}
        <div class="panel-group" id="accordion">
            <div class = "panel panel-default">
                <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" data-target="#collapseOne">
                    <h4 class="panel-title">
                        {% if questionnaire %}
                            <b>Editing Questionnaire "{{questionnaire.label}}"</b><b class="caret"></b>
                        {% else %}
                            <b>Create Questionnaire</b><b class="caret"></b>
                        {% endif %}
                    </h4>
                </div>
                <div id="collapseOne" class="panel-collapse collapse in">
                    <div class="panel-body">
                        <form onsubmit="return save()" onreset="empty()" id = "form-save" method="POST" action="/questionnaireAdmin/save">
                            {% csrf_token %}
                            <label for="title">Title</label>
                            <input type="text" name="title" class="form-control" id="title" placeholder="Enter title" value="{{questionnaire.label}}" required>
                            <br/>
                            <label for="intro">Introduction</label>
                            <input id="intro" class = "form-control" value="{{ questionnaire.intro }}" name="intro">
                            <br/>
                            <label for="select-questions">Select Questions</label>
                            <div class="row" id = "select-questions">
                                <div class="col-md-6">
                                    <small class="text-muted">Click the <span class="glyphicon glyphicon glyphicon-plus-sign text-primary"></span> icon to add questions to the questionnaire.</small>
                                    <table class='table moveable' id='question-table'>
                                        <thead>
                                            <tr>
                                                <th>Question</th>
                                                <th>Question Type</th>
                                                <th>Grouping</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        {% for question in questions %}
                                            <tr id="{{ question.pk }}">
                                                <td class="question-label">{{ question.questionLabel }}</td>
                                                <td class="question-type">{{ question.questionType.name }}</td>
                                                <td class="question-grouping-select" align="center">
                                                    <div class="dropdown">
                                                      <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown" id="group-select-{{ question.pk }}">Select Grouping
                                                      <span class="caret"></span></button>
                                                      <ul class="dropdown-menu" id="groups">
                                                        <li class="list-group-item" id="group-select-All-{{ question.pk }}"  align="center"><a style="cursor:pointer" onclick="changeGrouping('All', {{ question.pk }})">All</a></li>
                                                        <li class="list-group-item" id="group-select-Rest-{{ question.pk }}"  align="center"><a style="cursor:pointer" onclick="changeGrouping('Rest', {{ question.pk }})">Rest</a></li>
                                                        <li class="list-group-item" id="group-select-Label-{{ question.pk }}" align="center"><a style="cursor:pointer" onclick="changeGrouping('Label', {{ question.pk }})">Label <span class="glyphicon glyphicon glyphicon-arrow-right text-success pull-right"></span></a></li>
                                                        <li class="list-group-item" id="group-select-None-{{ question.pk }}" align="center"><a style="cursor:pointer" onclick="changeGrouping('None', {{ question.pk }})">None</a></li>
                                                      </ul>
                                                    </div>
                                                </td>
                                                <td class = "hidden"> {{ question.questionLabel }} </td>
                                                <input type="hidden" name="question-grouping-{{ question.pk }}" id="question-grouping-{{ question.pk }}" value="Rest">
                                                <td>
                                                    <span onclick="addQuestion(this)" class="glyphicon glyphicon glyphicon-plus-sign text-primary pull-right"  style="cursor:pointer"></span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Label table -->
                                <div class="hidden" id="label-table">
                                    <small class="text-muted">Click the <span class="glyphicon glyphicon-plus-sign text-primary"></span> icon to add
                                        labels.
                                    </small>
                                    <table class="table table-bordered" id="labeltable">
                                        <thead>
                                        <tr>
                                            <th class="text-center">
                                                <span>Labels for { question.pk }</span>
                                                <span style="cursor: pointer" onclick="addRowToTable(this)"
                                                      class="glyphicon glyphicon-plus-sign pull-right text-primary"></span>
                                            </th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-xs-6 labels-go-here">
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Click the <span class="glyphicon glyphicon glyphicon-minus-sign text-primary"></span> icon to remove questions from the questionnaire.</small>
                                    <table id="selected-questions" class="table moveable">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>Question</th>
                                                <th>Question Type</th>
                                                <th>Grouping</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for question in questionOrders %}
                                                <tr id = "{{ question.question.pk }}">
                                                    <td>
                                                        <span onclick="moveRow(this)" class="glyphicon glyphicon glyphicon-arrow-up text-primary pull-left"  style="cursor:pointer"></span>
                                                        <span onclick="moveRow(this)" class="glyphicon glyphicon glyphicon-arrow-down text-primary pull-left"  style="cursor:pointer"></span>
                                                    </td>
                                                    <td class = "question-label">{{ question.question.questionLabel }}</td>
                                                    <td class = "question-type">{{ question.question.questionType.name }}</td>
                                                    <td class = "question-grouping">{{ question.question.questionGrouping.grouping }}</td>
                                                    <td>
                                                        <span onclick="removeQuestion(this)" class="glyphicon glyphicon glyphicon-minus-sign text-primary pull-right"  style="cursor:pointer"></span>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <br/>
                            <input type="hidden" name="questions" id = "questions"> 
                            {% if questionnaire %}
                                <input type="hidden" name="pk" value="{{ questionnaire.pk }}">                
                            {% endif %}
                            <button type="submit" class = "btn btn-primary">
                                <span class="glyphicon glyphicon-ok"></span>
                                Submit
                            </button>
                            <button type="reset" class = "btn btn-primary pull-right">
                                <span class="glyphicon glyphicon-remove"></span>
                                {% if questionnaire %}
                                Cancel Edit
                                {% else %}
                                    Clear
                                {% endif %}
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" data-target="#collapseTwo">
                    <h4 class="panel-title">
                        <b>Maintain Questionnaires</b><b class="caret"></b>
                    </h4>
                </div>
                <div id="collapseTwo" class="panel-collapse collapse">
                    <div class="panel-body">
                        <input type="text" class="form-control" id="search" placeholder="Start typing to search">
                        <small class = "text-muted">Click the <span class="glyphicon glyphicon glyphicon-pencil text-primary"></span> icon to edit questionnaires, and the <span class="glyphicon glyphicon glyphicon-remove-circle text-primary"></span> icon to remove questionnaires.</small>
                    </div>
                    <table id = "questionnaire-list" class="table table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>
                                    Number of Questions
                                    <span id="delete-many" style = "cursor: pointer" onclick = "deleteMany()" class="glyphicon glyphicon glyphicon-remove-circle pull-right text-primary"></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for questionnaire in questionnaires %}
                                <tr
                                    {% if questionnaire.inARound  %} title="This questionnaire is in a round and cannot be deleted."
                                    {% else %} class = "deleteable" 
                                    {% endif %}
                                    id = "{{ questionnaire.pk }}"
                                >
                                    <td>
                                        {{ questionnaire.title }}
                                    </td>
                                    <td>
                                        {{ questionnaire.questionOrders.count }}
                                        {% if questionnaire.inARound %}
                                            <span class="glyphicon glyphicon glyphicon-remove-circle pull-right text-muted"></span>
                                        {% else %}
                                            <span style = "cursor: pointer" onclick = "deleteQuestionnaire('{{questionnaire.pk}}')" class="glyphicon glyphicon glyphicon-remove-circle pull-right text-primary"></span>
                                        {% endif %}
                                        <span style = "cursor: pointer" onclick = "preview('{{questionnaire.pk}}')" class="glyphicon glyphicon glyphicon glyphicon-eye-open pull-right text-primary">&nbsp</span>
                                        <span style = "cursor: pointer" onclick = "edit('{{questionnaire.pk}}')" class="glyphicon glyphicon glyphicon glyphicon-pencil pull-right text-primary">&nbsp</span>
                                    </td>
                                </tr>   
                            {% endfor %}
                        </tbody>
                    </table> 
                    <form id = "form-delete" action = "/questionnaireAdmin/delete" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name = "pk" id = "questionnaire-pk">
                    </form>   
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            tinymce.init({ selector:'#intro',
            language: 'en_GB',
            statusbar: false,
            menubar: '',
            plugins: ["emoticons", "image"],
            resize: true,
            toolbar: 'undo redo bold italiclignleft aligncenter alignright bullist numlist outdent indent styleselect fontsizeselect emoticons image a', });
            //Hide alerts
            setTimeout(function() {
                $('.alert').hide(100);
            }, 10000);
            //Todo: Search the other columns as well
            $("#search").keyup(function() {
                var value = this.value;
                $("#questionnaire-list").find("tr").each(function(index) {
                    if (!index) return;
                    var id = $(this).find("td").first().text();
                    $(this).toggle(id.toLowerCase().indexOf(value.toLowerCase()) !== -1);
                });
            });
            $('.labels-go-here').hide();
            $('.labels-go-here').html($('#label-table').html());
            {% for label in labels %}
                addLabel("{{label}}");
            {% endfor %}

            //Allows selecting of questions to delete multiple questions
            $('#delete-many').hide();
            $('#questionnaire-list').on('click', '.deleteable', function(event) {
                if ($(this).hasClass('active')) {
                    $(this).removeClass('active')
                } else {
                    $(this).addClass('active')
                }   
                if ($('#questionnaire-list').find('.active').length > 0) {
                    $('#delete-many').show(100);
                } else {
                    $('#delete-many').hide(100);                    
                }

            });

            $('#question-table').DataTable();

        });

        //** Functions used for table manipulations **//
        function addRowToTable(el) {
            var row = $('<td></td>');
            row.append('<input type="text" placeholder="Enter Label" style="border:none;"/>');
            row.append('<span onclick="removeRow(this)" class = "glyphicon glyphicon-remove-circle pull-right text-primary" style="cursor:pointer"></span>');
            row.append('<span onclick="moveRow(this)" class = "glyphicon glyphicon-arrow-up pull-left text-primary" style="cursor:pointer"></span>');
            row.append('<span onclick="moveRow(this)" class = "glyphicon glyphicon-arrow-down pull-left text-primary" style="cursor:pointer"></span>');

            $(el).closest('table').find('tbody').append(row);
            row.wrap('<tr></tr>');
            row.addClass('text-center');
            return row;
        }

        function addLabel(labelText) {
            row = addRowToTable($('#content').find('#labeltable')[0]);
            $(row).find('input').val(labelText);

        }

        function removeRow(el) {
            $(el).closest('tr').remove();
        }

        function moveRow(el) {
            var row = $(el).closest('tr');
            if ($(el).hasClass('glyphicon-arrow-up'))
                row.prev().before(row);
            else if ($(el).hasClass('glyphicon-arrow-down'))
                row.next().after(row);
        }

        function addQuestion(el) {              
            if ($(el).hasClass('text-primary')) {
                var row = $(el).closest('tr'); 
                var tr = $('<tr id = "'+row.attr('id')+'"></tr>');
                tr.append('<td><span onclick="moveRow(this)" class="glyphicon glyphicon glyphicon-arrow-up text-primary pull-left"  style="cursor:pointer"></span><span onclick="moveRow(this)" class="glyphicon glyphicon glyphicon-arrow-down text-primary pull-left"  style="cursor:pointer"></span></td>');
                tr.append('<td class="question-label">'+row.find('.question-label').html()+'</td>');
                tr.append('<td>'+row.find('.question-type').html()+'</td>');
                tr.append('<td>'+row.find('.question-grouping').html()+'</td>');
                tr.append('<td><span onclick="removeQuestion(this)" class="glyphicon glyphicon glyphicon-minus-sign text-primary pull-right"  style="cursor:pointer"></span></td>');
                $('#selected-questions').append(tr);
                //To ensure only one of each question in questionnaire
                // $(el).removeClass('text-primary').addClass('text-muted');
            }
        }

        function removeQuestion(el) {
            //To ensure one of each question in questionnaire
            // $('#question-table > tbody > tr:contains("'+$(el).closest('tr').find('.question-label').html()+'")').find('span.glyphicon-plus-sign').addClass('text-primary').removeClass('text-muted');
            $(el).closest('tr').remove();
        }

        function edit(pk) {
            window.location = '/questionnaireAdmin/edit/'+pk;
        }
        
        function preview(pk) {
            $("body").append("<a id='previewLink' href='/questionnairePreview/" + pk + "' target='_blank' style='display:none'></a>");
            // alert(getElementById('previewLink'));
            document.getElementById('previewLink').click();
            $("#previewLink").remove();
        } 

        function deleteQuestionnaire(pk) {
            $('#questionnaire-pk').val(pk);
            $('#form-delete').submit();
        }

        function deleteMany() {
            var pks = "";
            $('#questionnaire-list > tbody > tr.active').each(function(i, el) {
                pks += el.id + ';#';
            });
            $('#questionnaire-pk').val(pks.slice(0, -2));
            $('#form-delete').submit();
        }

        function save() {
            if ($('#question-type').val() == "Rank" && $('#question-grouping').val() == "Label") {
                if ($('#labeltable > tbody > tr > td > input').size() < 2) {
                    a = $('.container').eq(1).prepend('<div class = "alert alert-warning">Error: Rank with label grouping needs at least two labels.</div>');
                    setTimeout(function () {
                        $('.container').eq(1).find('.alert').hide(100);
                    }, 5000);
                    return false;
                }
            }
            var questions = "";
            $('#selected-questions > tbody > tr').each(function(i, el) {
                questions += el.id + ';#';
            });
            $('#questions').val(questions);
        }

        function empty() {
            {% if questionnaire %}
                window.location = '/questionnaireAdmin/';
            {% endif %}
            $('#selected-questions > tbody').empty();
        }

        function changeGrouping(group, questionId) {
            $("#group-select-" + questionId).text(group);
            $("#question-grouping-" + questionId).val(group);
            $("#groups > li").removeClass('active');
            $("#group-select-" + group + "-" + questionId).addClass('active');
            if (group == 'Label') {
                $(".labels-go-here").show(100);
            } else {
                $(".labels-go-here").hide(100);
            }
        }


        /*

        if ($('#question-grouping').val() == "Label") {
                var labels = "";
                $('#labeltable > tbody > tr > td > input').each(function (i, el) {
                    labels += el.value + ';#';
                });
                $('#question-labels').val(labels.slice(0, -2));
            }


            function empty() {
            $('.labels-go-here').html($('#label-table').html());

        */
    </script>
{% endblock %}