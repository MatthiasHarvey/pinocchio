{% extends "peer_review/base.html" %}
{% comment %}
Todo:
    Search question lists
    Filter question lists by type
    Move grouping choice to questionnaireAdmin
{% endcomment %}
{% load staticfiles %}

{% block extrahead %}
    <script src="{% static "peer_review/js/tinymce/tinymce.min.js" %}"></script>
    <link rel="stylesheet" href="{% static "peer_review/css/snackbar.css" %}">
    <title>Questionnaire Admin</title>
    <script>
        var title="questionnaireAdmin";
    </script>

{% endblock %}

{% block context %}
    <div class = "container">
        {% if messages %}
            {% for message in messages %}
            <div class = "alert alert-{{ message.tags }}"><strong>{{ message }}</strong></div>
            {% endfor %}
        {% endif %}
        <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Confirm Delete</h4>
                    </div>
                    <div class="modal-body">
                        <p id="delete-msg"></p>
                        <p id="delete-questionnaire" font-size="14pt"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <a class="btn btn-danger" onclick="$('#form-delete').submit()">Delete</a>
                    </div>
                </div>
            </div>
        </div>
        <div id="snackbar"></div>
        <div class="panel-group" id="accordion">
            <div class = "panel panel-default">
                <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" data-target="#collapseOne">
                    <h4 class="panel-title">
                        {% if questionnaire %}
                            <b>Editing Questionnaire "{{questionnaire.label}}"</b><b class="caret"></b>
                        {% else %}
                            <b>Create Questionnaire</b><b class="caret"></b>
                        {% endif %}
                    </h4>
                </div>
                <div id="collapseOne" class="panel-collapse collapse in">
                    <div class="panel-body">
                        <form onsubmit="return save()" onreset="empty()" id = "form-save" method="POST" action="/questionnaireAdmin/save">
                            {% csrf_token %}
                            <label for="title">Title</label>
                            <input type="text" name="title" class="form-control" id="title" placeholder="Enter title" value="{{questionnaire.label}}" required>
                            <br/>
                            <label for="intro">Introduction</label>
                            <input id="intro" class = "form-control" value="{{ questionnaire.intro }}" name="intro">
                            <br/>
                            <label for="select-questions">Select Questions</label>
                            <div class="row" id = "select-questions">
                                <div class="col-md-6">
                                    <small class="text-muted">Click the <span class="glyphicon glyphicon glyphicon-plus-sign text-primary"></span> icon to add questions to the questionnaire.</small>
                                    <table class='table moveable' id='question-table'>
                                        <thead>
                                            <tr>
                                                <th>Question</th>
                                                <th>Question Type</th>
                                                <th>Grouping</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        {% for question in questions %}
                                            <tr id="{{ question.pk }}">
                                                <td class="question-label">{{ question.questionLabel }}</td>
                                                <td class="question-type">{{ question.questionType.name }}</td>
                                                <td class="question-grouping-select" align="center">
                                                    <div class="dropdown">
                                                      <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown" id="group-select-{{ question.pk }}">Select Grouping <span class="caret"></span></button>
                                                      <ul class="dropdown-menu" id="groups">
                                                        {% for grup in questgrouping %}
                                                            <li class="list-group-item" id="group-select-{{ grup }}-{{ question.pk }}" align="center"><a style="cursor: pointer" onclick="changeGrouping('{{ grup }}', {{ question.pk }})">{{ grup }}</a></li>
                                                        {% endfor %}
                                                      </ul>
                                                    </div>
                                                </td>
                                                <input type="hidden" id="question-label-{{ question.pk }}" value="{{ question.questionLabel }}">
                                                <input type="hidden" id="question-grouping-{{ question.pk }}" value="Rest">
                                                <td id="addBtn-{{ question.pk }}">
                                                    <span onclick="addQuestion(this)" class="glyphicon glyphicon glyphicon-plus-sign text-primary pull-right"  style="cursor:pointer"></span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Label table -->
                                <div class="hidden" id="label-table">
                                    <input type="hidden" name="labelCount" id="labelCount" value="0">
                                    <small class="text-muted">Click the <span class="glyphicon glyphicon-plus-sign text-primary"></span> icon to add
                                        labels.
                                    </small>
                                    <table class="table table-bordered" id="labeltable">
                                        <thead>
                                        <tr>
                                            <th class="text-center">
                                                <label id="label-heading">Labels for { question }</label>
                                                <span style="cursor: pointer" onclick="addRowToTable(this)"
                                                      class="glyphicon glyphicon-plus-sign pull-right text-primary"></span>
                                            </th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-xs-6 labels-go-here"></div>
                                <div class="col-md-6">
                                    <small class="text-muted">Click the <span class="glyphicon glyphicon glyphicon-minus-sign text-primary"></span> icon to remove questions from the questionnaire.</small>
                                    <table id="selected-questions" class="table moveable">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>Question</th>
                                                <th>Question Type</th>
                                                <th>Grouping</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for question in questionOrders %}
                                                <tr id = "{{ question.question.pk }}">
                                                    <td>
                                                        <span onclick="moveRow(this)" class="glyphicon glyphicon glyphicon-arrow-up text-primary pull-left"  style="cursor:pointer"></span>
                                                        <span onclick="moveRow(this)" class="glyphicon glyphicon glyphicon-arrow-down text-primary pull-left"  style="cursor:pointer"></span>
                                                    </td>
                                                    <td class = "question-label">{{ question.question.questionLabel }}</td>
                                                    <td class = "question-type">{{ question.question.questionType.name }}</td>
                                                    <td class = "question-grouping">{{ question.question.questionGrouping.grouping }}</td>
                                                    <td>
                                                        <span onclick="removeQuestion(this)" class="glyphicon glyphicon glyphicon-minus-sign text-primary pull-right"  style="cursor:pointer"></span>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <br/>
                            <input type="hidden" name="questions" id = "questions"> 
                            {% if questionnaire %}
                                <input type="hidden" name="pk" value="{{ questionnaire.pk }}">                
                            {% endif %}
                            <button type="submit" class = "btn btn-primary">
                                <span class="glyphicon glyphicon-ok"></span>
                                Submit
                            </button>
                            <button type="reset" class = "btn btn-primary pull-right">
                                <span class="glyphicon glyphicon-remove"></span>
                                {% if questionnaire %}
                                Cancel Edit
                                {% else %}
                                    Clear
                                {% endif %}
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" data-target="#collapseTwo">
                    <h4 class="panel-title">
                        <b>Maintain Questionnaires</b><b class="caret"></b>
                    </h4>
                </div>
                <div id="collapseTwo" class="panel-collapse collapse">
                    <div class="panel-body">
                        <input type="text" class="form-control" id="search" placeholder="Start typing to search">
                        <small class = "text-muted">Click the <span class="glyphicon glyphicon glyphicon-pencil text-primary"></span> icon to edit questionnaires, and the <span class="glyphicon glyphicon glyphicon-remove-circle text-primary"></span> icon to remove questionnaires.</small>
                    </div>
                    <table id = "questionnaire-list" class="table table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>
                                    Number of Questions
                                    <span id="delete-many" style = "cursor: pointer" onclick = "deleteMany()" class="glyphicon glyphicon glyphicon-remove-circle pull-right text-primary" data-toggle="modal" data-target="#confirm-delete"></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for questionnaire in questionnaires %}
                                <tr
                                    {% if questionnaire.inARound  %} title="This questionnaire is in a round and cannot be deleted."
                                    {% else %} class = "deleteable" 
                                    {% endif %}
                                    id = "{{ questionnaire.pk }}"
                                >
                                    <td>
                                        {{ questionnaire.title }}
                                    </td>
                                    <td>
                                        {{ questionnaire.questionOrders.count }}
                                        {% if questionnaire.inARound %}
                                            <span class="glyphicon glyphicon glyphicon-remove-circle pull-right text-muted"></span>
                                        {% else %}
                                            <span style = "cursor: pointer" onclick = "deleteQuestionnaire('{{questionnaire.pk}}')" class="glyphicon glyphicon glyphicon-remove-circle pull-right text-primary" data-toggle="modal" data-target="#confirm-delete"></span>
                                        {% endif %}
                                        <span style = "cursor: pointer" onclick = "preview('{{questionnaire.pk}}')" class="glyphicon glyphicon glyphicon glyphicon-eye-open pull-right text-primary">&nbsp</span>
                                        <span style = "cursor: pointer" onclick = "edit('{{questionnaire.pk}}')" class="glyphicon glyphicon glyphicon glyphicon-pencil pull-right text-primary">&nbsp</span>
                                    </td>
                                </tr>   
                            {% endfor %}
                        </tbody>
                    </table> 
                    <form id = "form-delete" action = "/questionnaireAdmin/delete" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name = "pk" id = "questionnaire-pk">
                    </form>   
                </div>
            </div>
        </div>
    </div>

    <script>
        var questionTable = null;
        $(document).ready(function() {
            tinymce.init({ selector:'#intro',
            language: 'en_GB',
            statusbar: false,
            menubar: '',
            plugins: ["emoticons", "image"],
            resize: true,
            toolbar: 'undo redo bold italiclignleft aligncenter alignright bullist numlist outdent indent styleselect fontsizeselect emoticons image a', });
            //Hide alerts
            setTimeout(function() {
                $(".alert").fadeTo(500, 0).slideUp(500, function(){
                    $(this).remove(); 
                });
            }, 5000);
            //Todo: Search the other columns as well
            $("#search").keyup(function() {
                var value = this.value;
                $("#questionnaire-list").find("tr").each(function(index) {
                    if (!index) return;
                    var id = $(this).find("td").first().text();
                    $(this).toggle(id.toLowerCase().indexOf(value.toLowerCase()) !== -1);
                });
            });
            $('.labels-go-here').hide();
            $('.labels-go-here').html($('#label-table').html());
            {% for label in labels %}
                addLabel("{{label}}");
            {% endfor %}

            //Allows selecting of questions to delete multiple questions
            $('#delete-many').hide();
            $('#questionnaire-list').on('click', '.deleteable', function(event) {
                if ($(this).hasClass('active')) {
                    $(this).removeClass('active')
                } else {
                    $(this).addClass('active')
                }   
                if ($('#questionnaire-list').find('.active').length > 0) {
                    $('#delete-many').show(100);
                } else {
                    $('#delete-many').hide(100);                    
                }

            });

            questionTable = $('#question-table').DataTable({paging: true});
        });

        //** Functions used for table manipulations **//
        function addRowToTable(el) {
            var row = $('<td></td>');
            row.append('<input type="text" placeholder="Enter Label" style="border:none;"/>');
            row.append('<span onclick="removeRow(this)" class = "glyphicon glyphicon-remove-circle pull-right text-primary" style="cursor:pointer"></span>');
            row.append('<span onclick="moveRow(this)" class = "glyphicon glyphicon-arrow-up pull-left text-primary" style="cursor:pointer"></span>');
            row.append('<span onclick="moveRow(this)" class = "glyphicon glyphicon-arrow-down pull-left text-primary" style="cursor:pointer"></span>');

            $(el).closest('table').find('tbody').append(row);
            row.wrap('<tr></tr>');
            row.addClass('text-center');
            labCount = $("#labelCount").val();
            labCount++;
            $("#labelCount").val(labCount);
            return row;
        }

        function addLabel(labelText) {
            row = addRowToTable($('#content').find('#labeltable')[0]);
            $(row).find('input').val(labelText);

        }

        function removeRow(el) {
            $(el).closest('tr').remove();
            labCount = $("#labelCount").val();
            labCount--;
            $("#labelCount").val(labCount);
        }

        function moveRow(el) {
            var row = $(el).closest('tr');
            if ($(el).hasClass('glyphicon-arrow-up'))
                row.prev().before(row);
            else if ($(el).hasClass('glyphicon-arrow-down'))
                row.next().after(row);
        }

        function showSnackbar(msg) {
            $("#snackbar").html(msg);
            $("#snackbar").addClass("show");
            setTimeout(function() {
                $("#snackbar").removeClass("show");
            }, 3000);
        }

        function addQuestion(el) {
            if ($(el).hasClass('text-primary')) {
                var row = $(el).closest('tr');
                var questLabel = row.find('.question-label').html();
                if (row.find("#group-select-" + row.attr("id")).html().includes("Select Grouping")) {
                    showSnackbar("Please select grouping for: <strong>" + questLabel + "</strong>");
                } else {
                    if ($("#question-grouping-" + row.attr("id")).val() == "Label") {
                        if($("#labelCount").val() < 1) {
                            showSnackbar("Please enter labels for: <strong>" + questLabel + "</strong>");
                            return;
                        } else {
                            // Store labels
                            var labels = "";
                            var shouldContinue = true;
                            $('#labeltable > tbody > tr > td > input').each(function (i, el) {
                                if(!$.trim(el.value).length) {
                                    showSnackbar("Please fill in blank labels");
                                    shouldContinue = false;
                                }
                                labels += el.value.trim() + ';#';
                            });
                            if(shouldContinue) {
                                $('#question-labels').val(labels.slice(0, -2));
                                // empty table
                                $('.labels-go-here').html($('#label-table').html());
                                $(".labels-go-here").hide(100);    
                            } else {
                                return;
                            }
                        }
                    }

                    var tr = $('<tr id = "'+row.attr('id')+'"></tr>');
                    tr.append('<td><span onclick="moveRow(this)" class="glyphicon glyphicon glyphicon-arrow-up text-primary pull-left"  style="cursor:pointer"></span><span onclick="moveRow(this)" class="glyphicon glyphicon glyphicon-arrow-down text-primary pull-left"  style="cursor:pointer"></span></td>');
                    tr.append('<td class="question-label">'+row.find('.question-label').html()+'</td>');
                    tr.append('<td>'+row.find('.question-type').html()+'</td>');
                    tr.append('<td>'+row.find("#question-grouping-" + row.attr("id")).val()+'</td>');
                    tr.append('<td><span onclick="removeQuestion(this)" class="glyphicon glyphicon glyphicon-minus-sign text-primary pull-right"  style="cursor:pointer"></span></td>');
                    $('#selected-questions').append(tr);
                    // Disable grouping and add buttons
                    $("#group-select-" + row.attr("id")).prop("disabled", true);
                    $("#addBtn-" + $(el).closest('tr').attr('id')).html('<span class="glyphicon glyphicon glyphicon-plus-sign text-muted pull-right"  title="Question already added"></span>');
                    //To ensure only one of each question in questionnaire
                    // $(el).removeClass('text-primary').addClass('text-muted');
                }
            }
        }

        function removeQuestion(el) {
            // Enable grouping and add buttons
            curPage = questionTable.page.info().page;
            questionTable.destroy(); // Refresh across pages in datatable
            $("#group-select-" + $(el).closest('tr').attr("id")).prop("disabled", false);
            $("#addBtn-" + $(el).closest('tr').attr('id')).html('<span onclick="addQuestion(this)" class="glyphicon glyphicon glyphicon-plus-sign text-primary pull-right"  style="cursor:pointer"></span>');
            questionTable = $('#question-table').DataTable({paging: true});
            questionTable.page(curPage).draw('page');
            $(el).closest('tr').remove();
        }

        function edit(pk) {
            window.location = '/questionnaireAdmin/edit/'+pk;
        }
        
        function preview(pk) {
            $("body").append("<a id='previewLink' href='/questionnairePreview/" + pk + "' target='_blank' style='display:none'></a>");
            // alert(getElementById('previewLink'));
            document.getElementById('previewLink').click();
            $("#previewLink").remove();
        }

        function deleteQuestionnaire(pk) {
            var strcnf = "";
            $('#questionnaire-pk').val(pk);
            {% for questn in questionnaires %}
                if ("{{ questn.pk }}" == pk) {
                    strcnf = "{{ questn.title }}";
                }
            {% endfor %}
            $('#delete-msg').html('You are about to delete the following questionnaire, this procedure is irreversible.');
            $('#delete-questionnaire').html('<strong>' + strcnf + '</strong>');
        }

        function deleteMany() {
            var pks = "";
            var strcnf = "";
            $('#questionnaire-list > tbody > tr.active').each(function(i, el) {
                {% for questn in questionnaires %}
                    if ("{{ questn.pk }}" == el.id) {
                        strcnf += "{{ questn.title }}<br/>";
                    }
                {% endfor %}
                pks += el.id + ';#';
            });
            $('#questionnaire-pk').val(pks.slice(0, -2));
            $('#delete-msg').html('You are about to delete the following questionnaires, this procedure is irreversible.');
            $('#delete-questionnaire').html('<strong>' + strcnf + '</strong>');
        }

        function save() {
            // Rewrite validation


             /* TODO ---------------------------------------------------------- */

             
            if ($('#question-type').val() == "Rank" && $('#question-grouping').val() == "Label") {
                if ($('#labeltable > tbody > tr > td > input').size() < 2) {
                    a = $('.container').eq(1).prepend('<div class = "alert alert-warning">Error: Rank with label grouping needs at least two labels.</div>');
                    setTimeout(function () {
                        $('.container').eq(1).find('.alert').hide(100);
                    }, 5000);
                    return false;
                }
            }
            var questions = "";
            $('#selected-questions > tbody > tr').each(function(i, el) {
                questions += el.id + ';#';
            });
            $('#questions').val(questions);
        }

        function empty() {
            {% if questionnaire %}
                window.location = '/questionnaireAdmin/';
            {% endif %}
            $('#selected-questions > tbody > tr').each(function (i, el) {
                removeQuestion(el);
            });
            $(".labels-go-here").hide(100);
            curPage = questionTable.page.info().page;
            questionTable.destroy(); // Refresh across pages in datatable
            $('#question-table > tbody > tr').each(function (i, el) {
                $("#group-select-" + el.id).html("Select Grouping <span class=\"caret\"></span>");
                {% for label in labels %}
                    $("#group-select-{{ label }}-" + el.id).removeClass('active');
                {% endfor %}
            });
            questionTable = $('#question-table').DataTable({paging: true});
            questionTable.page(curPage).draw('page');
        }

        function changeGrouping(group, questionId) {
            $("#group-select-" + questionId).html(group + " <span class=\"caret\"></span>");
            $("#question-grouping-" + questionId).val(group);
            $("#groups > li").removeClass('active');
            $("#group-select-" + group + "-" + questionId).addClass('active');
            if (group == "Label") {
                $("#label-heading").text("Labels: " + $("#question-label-" + questionId).val());
                $('.labels-go-here').html($('#label-table').html()); // Set new table
                $(".labels-go-here").show(100);
            } else {
                $(".labels-go-here").hide(100);
            }
        }
    </script>
{% endblock %}